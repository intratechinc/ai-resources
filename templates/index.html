<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intratech Cybersecurity Suite - AI-Powered Security Operations Center</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a202c 50%, #2d3748 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: rgba(26, 32, 44, 0.95);
            padding: 1rem 2rem;
            border-bottom: 2px solid #4fd1c7;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.8rem;
            font-weight: 700;
            color: #4fd1c7;
        }

        .logo {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .agent-card {
            background: rgba(26, 32, 44, 0.8);
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid rgba(79, 209, 199, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .agent-card:hover {
            border-color: #4fd1c7;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 209, 199, 0.2);
        }

        .agent-card.selected {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .agent-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .agent-icon {
            font-size: 2rem;
            color: #4fd1c7;
        }

        .agent-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-active { background-color: #48bb78; }
        .status-busy { background-color: #ed8936; }
        .status-inactive { background-color: #a0aec0; }

        .agent-description {
            color: #a0aec0;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .agent-capabilities {
            margin-bottom: 1rem;
        }

        .capability-tag {
            display: inline-block;
            background: rgba(79, 209, 199, 0.2);
            color: #4fd1c7;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 0.25rem 0.25rem 0.25rem 0;
        }

        .task-selector {
            margin-top: 1rem;
        }

        .task-dropdown {
            width: 100%;
            background: rgba(45, 55, 72, 0.8);
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 6px;
            padding: 0.5rem;
            color: #e2e8f0;
            margin-bottom: 0.5rem;
        }

        .execute-btn {
            width: 100%;
            background: linear-gradient(45deg, #4fd1c7, #38b2ac);
            border: none;
            border-radius: 6px;
            padding: 0.75rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .execute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 209, 199, 0.3);
        }

        .execute-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-panel {
            background: rgba(26, 32, 44, 0.8);
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid rgba(79, 209, 199, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(79, 209, 199, 0.3);
        }

        .selected-agent-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(45, 55, 72, 0.3);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 90%;
        }

        .message.user {
            background: rgba(79, 209, 199, 0.2);
            margin-left: auto;
            border: 1px solid rgba(79, 209, 199, 0.3);
        }

        .message.agent {
            background: rgba(72, 187, 120, 0.2);
            margin-right: auto;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }

        .message.system {
            background: rgba(237, 137, 54, 0.2);
            margin: 0 auto;
            text-align: center;
            border: 1px solid rgba(237, 137, 54, 0.3);
        }

        .message-header {
            font-size: 0.8rem;
            color: #a0aec0;
            margin-bottom: 0.5rem;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .input-field {
            flex: 1;
            background: rgba(45, 55, 72, 0.8);
            border: 2px solid rgba(79, 209, 199, 0.3);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            font-size: 1rem;
        }

        .input-field:focus {
            outline: none;
            border-color: #4fd1c7;
        }

        .send-button {
            background: linear-gradient(45deg, #4fd1c7, #38b2ac);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(26, 32, 44, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid rgba(79, 209, 199, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1001;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: #a0aec0;
            font-style: italic;
            margin: 1rem 0;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #4fd1c7;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        .task-progress {
            background: rgba(45, 55, 72, 0.8);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid rgba(79, 209, 199, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(79, 209, 199, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fd1c7, #48bb78);
            transition: width 0.3s ease;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
            
            .chat-panel {
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .agents-grid {
                grid-template-columns: 1fr;
            }
            
            .main-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>
            <div class="logo">üõ°Ô∏è</div>
            Intratech Cybersecurity Suite
            <span style="font-size: 0.8rem; color: #a0aec0; margin-left: auto;">AI-Powered Security Operations Center</span>
        </h1>
    </header>

    <div class="connection-status">
        <div class="status-indicator status-active" id="connectionIndicator"></div>
        <span id="connectionStatus">Connected</span>
    </div>

    <div class="main-container">
        <div class="agents-section">
            <h2 style="margin-bottom: 1.5rem; color: #4fd1c7;">ü§ñ Cybersecurity Agents</h2>
            <div class="agents-grid" id="agentsGrid">
                <!-- Debug: This should be replaced by JavaScript -->
                <div style="color: #a0aec0; text-align: center; padding: 2rem;">
                    Loading agents...
                </div>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                <div class="selected-agent-info" id="selectedAgentInfo">
                    <i class="fas fa-robot" style="font-size: 1.5rem; color: #4fd1c7;"></i>
                    <div>
                        <div style="font-weight: 600;">Select an Agent</div>
                        <div style="font-size: 0.9rem; color: #a0aec0;">Choose an agent to start interaction</div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    <div class="message-header">System ‚Ä¢ Welcome</div>
                    <div>
                        <h3>üõ°Ô∏è Welcome to Intratech Cybersecurity Suite</h3>
                        <p>Your AI-powered security operations center is ready.</p>
                        <br>
                        <p><strong>How to use:</strong></p>
                        <p>1. Click on any agent card to select it</p>
                        <p>2. Choose a task from the dropdown menu</p>
                        <p>3. Click "Execute Task" or chat directly</p>
                        <br>
                        <p><strong>Available Agents:</strong> Threat Intelligence, Vulnerability Scanner, Penetration Testing, Incident Response, OSINT, Malware Analysis, Network Security, Compliance, Forensics</p>
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span>Agent is processing</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="input-container">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="input-field" 
                    placeholder="Select an agent first, then type your message..."
                    disabled
                >
                <button id="sendButton" class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <!-- Socket.IO and JavaScript -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        class CybersecuritySuite {
            constructor() {
                this.socket = io({
                    transports: ['polling', 'websocket'],
                    upgrade: true,
                    timeout: 20000,
                    forceNew: false,
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 5,
                    maxReconnectionAttempts: 5
                });

                this.selectedAgent = null;
                this.agents = {};
                this.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                
                this.initializeElements();
                this.setupEventListeners();
                this.setupSocketListeners();
                this.loadAgents();
            }

            initializeElements() {
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatMessages = document.getElementById('chatMessages');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.agentsGrid = document.getElementById('agentsGrid');
                this.selectedAgentInfo = document.getElementById('selectedAgentInfo');
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            setupSocketListeners() {
                this.socket.on('connect', () => {
                    this.updateConnectionStatus(true);
                    this.addSystemMessage('Connected to Intratech Cybersecurity Suite');
                    // Don't load agents here - already loaded in constructor
                });

                this.socket.on('disconnect', () => {
                    this.updateConnectionStatus(false);
                    this.addSystemMessage('Disconnected from server');
                });

                this.socket.on('chat_response', (data) => {
                    this.hideTypingIndicator();
                    this.addMessage(data.response, 'agent', this.selectedAgent?.name || 'Agent');
                    this.enableInput();
                });

                this.socket.on('agent_status', (data) => {
                    this.updateAgentStatus(data);
                });

                this.socket.on('task_response', (data) => {
                    this.hideTypingIndicator();
                    this.addMessage(`Task executed: ${data.task_type}\nStatus: ${data.status}`, 'agent', this.selectedAgent?.name || 'Agent');
                    this.enableInput();
                });

                this.socket.on('error', (error) => {
                    this.hideTypingIndicator();
                    this.addMessage('Error: ' + error.message, 'system');
                    this.enableInput();
                });
            }

            async loadAgents() {
                try {
                    console.log('Loading agents...');
                    const response = await fetch('/api/agents');
                    console.log('Response status:', response.status);
                    const agents = await response.json();
                    console.log('Agents loaded:', agents);
                    this.agents = agents;
                    this.renderAgents();
                } catch (error) {
                    console.error('Failed to load agents:', error);
                    this.addSystemMessage('Failed to load agents');
                }
            }

            renderAgents() {
                console.log('Rendering agents...');
                this.agentsGrid.innerHTML = '';
                
                const agentConfigs = {
                    threat_intelligence: {
                        icon: 'fas fa-shield-virus',
                        description: 'Analyzes threats, IOCs, and threat actor intelligence using Shodan, VirusTotal, and OSINT',
                        tasks: [
                            'Analyze IP address 8.8.8.8 for threats and geolocation',
                            'Check domain reputation for suspicious.com',
                            'Investigate file hash with VirusTotal lookup',
                            'Research threat actor APT groups and TTPs',
                            'IOC correlation analysis across multiple sources',
                            'Threat hunting query with Shodan search',
                            'Dark web monitoring for leaked credentials',
                            'Malware family attribution analysis',
                            'Threat landscape assessment report',
                            'Cyber threat intelligence briefing'
                        ]
                    },
                    vulnerability_scanner: {
                        icon: 'fas fa-bug',
                        description: 'Scans for vulnerabilities using Nmap, Nuclei, SSL analyzers, and security auditing tools',
                        tasks: [
                            'Nmap port scan on 192.168.1.0/24 network',
                            'Nuclei vulnerability scan on https://example.com',
                            'SSL/TLS certificate analysis and security check',
                            'Web application security headers audit',
                            'CVE lookup and CVSS scoring analysis',
                            'Network service enumeration and fingerprinting',
                            'WordPress security assessment',
                            'Database security configuration review',
                            'Cloud infrastructure security scan',
                            'API endpoint security testing'
                        ]
                    },
                    penetration_testing: {
                        icon: 'fas fa-user-ninja',
                        description: 'Performs ethical hacking, penetration testing, and security assessments',
                        tasks: [
                            'Web application penetration test with SQL injection',
                            'Network reconnaissance and enumeration',
                            'Directory traversal and file discovery scan',
                            'Social engineering assessment and phishing simulation',
                            'Wireless network security testing (WPA/WEP)',
                            'Privilege escalation testing and exploitation',
                            'Buffer overflow and memory corruption testing',
                            'Active Directory security assessment',
                            'Cloud penetration testing (AWS/Azure)',
                            'Mobile application security testing'
                        ]
                    },
                    incident_response: {
                        icon: 'fas fa-exclamation-triangle',
                        description: 'Handles security incidents, breaches, and emergency response coordination',
                        tasks: [
                            'Ransomware incident response and containment',
                            'Data breach investigation and forensics',
                            'Malware outbreak containment strategy',
                            'DDoS attack mitigation and analysis',
                            'Insider threat investigation',
                            'Business continuity planning',
                            'Evidence preservation and chain of custody',
                            'Stakeholder communication during incidents',
                            'Post-incident analysis and lessons learned',
                            'Incident response playbook execution'
                        ]
                    },
                    osint: {
                        icon: 'fas fa-search',
                        description: 'Conducts open source intelligence gathering and digital investigations',
                        tasks: [
                            'Domain and subdomain enumeration analysis',
                            'Email address OSINT and breach database lookup',
                            'Social media intelligence gathering',
                            'Company and employee information research',
                            'Dark web monitoring for stolen credentials',
                            'Cryptocurrency transaction analysis',
                            'Geolocation and metadata analysis',
                            'Threat actor profiling and attribution',
                            'Brand monitoring and impersonation detection',
                            'Supply chain risk assessment'
                        ]
                    },
                    malware_analysis: {
                        icon: 'fas fa-virus',
                        description: 'Analyzes malicious files, malware families, and threat samples',
                        tasks: [
                            'Static malware analysis and file hashing',
                            'Dynamic sandbox behavior analysis',
                            'VirusTotal multi-engine malware scanning',
                            'Malware family classification and attribution',
                            'IOC extraction and signature generation',
                            'Reverse engineering and code analysis',
                            'Command and control (C2) infrastructure analysis',
                            'Payload delivery mechanism investigation',
                            'Ransomware strain identification',
                            'Mobile malware analysis (APK/IPA)'
                        ]
                    },
                    network_security: {
                        icon: 'fas fa-network-wired',
                        description: 'Monitors network traffic, analyzes connections, and detects intrusions',
                        tasks: [
                            'Network traffic analysis with packet capture',
                            'Active network connections monitoring',
                            'Intrusion detection system (IDS) analysis',
                            'Firewall rule optimization and log review',
                            'Network anomaly and DDoS detection',
                            'Bandwidth usage and performance analysis',
                            'Network topology discovery and mapping',
                            'Wireless network security assessment',
                            'VPN security configuration review',
                            'Network segmentation effectiveness testing'
                        ]
                    },
                    compliance: {
                        icon: 'fas fa-clipboard-check',
                        description: 'Ensures regulatory compliance and security policy adherence',
                        tasks: [
                            'SOC 2 Type II compliance assessment',
                            'GDPR data protection compliance audit',
                            'HIPAA security and privacy evaluation',
                            'PCI DSS payment security compliance scan',
                            'ISO 27001 information security gap analysis',
                            'NIST Cybersecurity Framework assessment',
                            'Security policy review and recommendations',
                            'Risk assessment and mitigation planning',
                            'Vendor security assessment questionnaire',
                            'Regulatory reporting and documentation'
                        ]
                    },
                    forensics: {
                        icon: 'fas fa-fingerprint',
                        description: 'Performs digital forensics, evidence analysis, and cyber investigations',
                        tasks: [
                            'Digital evidence acquisition and preservation',
                            'File system forensics and deleted file recovery',
                            'Memory dump analysis and volatile data extraction',
                            'Network forensics and traffic reconstruction',
                            'Mobile device forensics (iOS/Android)',
                            'Timeline analysis and event correlation',
                            'Malware forensics and reverse engineering',
                            'Email forensics and metadata analysis',
                            'Cloud forensics and log analysis',
                            'Legal evidence documentation and chain of custody'
                        ]
                    }
                };

                Object.entries(this.agents).forEach(([agentId, agent]) => {
                    if (agentId === 'coordinator') return; // Skip coordinator in main grid
                    
                    console.log(`Rendering agent: ${agentId}`, agent);
                    
                    const config = agentConfigs[agentId] || {
                        icon: 'fas fa-robot',
                        description: 'Specialized cybersecurity agent',
                        tasks: ['General security analysis', 'Custom task execution']
                    };

                    const agentCard = this.createAgentCard(agentId, agent, config);
                    this.agentsGrid.appendChild(agentCard);
                });
            }

            createAgentCard(agentId, agent, config) {
                const card = document.createElement('div');
                card.className = 'agent-card';
                card.dataset.agentId = agentId;

                const capabilities = ['AI Analysis', 'Real-time Processing', 'Automated Response', 'Threat Detection'];

                card.innerHTML = `
                    <div class="agent-header">
                        <div class="agent-info">
                            <i class="${config.icon} agent-icon"></i>
                            <div>
                                <div class="agent-name">${agent.name}</div>
                                <div class="agent-status">
                                    <div class="status-indicator status-${agent.status}"></div>
                                    ${agent.status.toUpperCase()}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="agent-description">${config.description}</div>
                    <div class="agent-capabilities">
                        ${capabilities.map(cap => `<span class="capability-tag">${cap}</span>`).join('')}
                    </div>
                    <div class="task-selector">
                        <select class="task-dropdown" id="task-${agentId}">
                            <option value="">Select a task...</option>
                            ${config.tasks.map(task => `<option value="${task}">${task}</option>`).join('')}
                        </select>
                        <button class="execute-btn" onclick="cybersecuritySuite.executeTask('${agentId}')">
                            <i class="fas fa-play"></i> Execute Task
                        </button>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.task-selector')) {
                        this.selectAgent(agentId, agent, config);
                    }
                });

                return card;
            }

            selectAgent(agentId, agent, config) {
                // Remove previous selection
                document.querySelectorAll('.agent-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select new agent
                const selectedCard = document.querySelector(`[data-agent-id="${agentId}"]`);
                selectedCard.classList.add('selected');

                this.selectedAgent = { id: agentId, ...agent, config };

                // Update chat header
                this.selectedAgentInfo.innerHTML = `
                    <i class="${config.icon}" style="font-size: 1.5rem; color: #4fd1c7;"></i>
                    <div>
                        <div style="font-weight: 600;">${agent.name}</div>
                        <div style="font-size: 0.9rem; color: #a0aec0;">${config.description}</div>
                    </div>
                `;

                // Enable input
                this.messageInput.disabled = false;
                this.sendButton.disabled = false;
                this.messageInput.placeholder = `Chat with ${agent.name}...`;
                this.messageInput.focus();

                this.addSystemMessage(`Selected ${agent.name}. You can now chat or execute tasks.`);
            }

            executeTask(agentId) {
                const taskSelect = document.getElementById(`task-${agentId}`);
                const selectedTask = taskSelect.value;

                if (!selectedTask) {
                    alert('Please select a task first');
                    return;
                }

                this.selectAgent(agentId, this.agents[agentId], this.getAgentConfig(agentId));
                
                this.showTypingIndicator();
                this.disableInput();

                // Send task execution request
                this.socket.emit('execute_task', {
                    agent_type: agentId,
                    task_type: 'execute_predefined_task',
                    parameters: {
                        task_description: selectedTask,
                        user_id: this.userId
                    },
                    user_id: this.userId
                });

                this.addMessage(`Executing task: ${selectedTask}`, 'user');
                taskSelect.value = ''; // Reset selection
            }

            getAgentConfig(agentId) {
                const configs = {
                    threat_intelligence: { icon: 'fas fa-shield-virus' },
                    vulnerability_scanner: { icon: 'fas fa-bug' },
                    penetration_testing: { icon: 'fas fa-user-ninja' },
                    incident_response: { icon: 'fas fa-exclamation-triangle' },
                    osint: { icon: 'fas fa-search' },
                    malware_analysis: { icon: 'fas fa-virus' },
                    network_security: { icon: 'fas fa-network-wired' },
                    compliance: { icon: 'fas fa-clipboard-check' },
                    forensics: { icon: 'fas fa-fingerprint' }
                };
                return configs[agentId] || { icon: 'fas fa-robot' };
            }

            sendMessage() {
                if (!this.selectedAgent) {
                    alert('Please select an agent first');
                    return;
                }

                const message = this.messageInput.value.trim();
                if (!message) return;

                this.addMessage(message, 'user');
                this.disableInput();
                this.showTypingIndicator();

                this.socket.emit('chat_message', {
                    user_id: this.userId,
                    message: message,
                    agent_type: this.selectedAgent.id
                });

                this.messageInput.value = '';
            }

            addMessage(content, type, agentName = '') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const timestamp = new Date().toLocaleTimeString();
                const sender = type === 'user' ? 'You' : (agentName || 'Agent');
                
                const header = document.createElement('div');
                header.className = 'message-header';
                header.textContent = `${sender} ‚Ä¢ ${timestamp}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = this.formatMessage(content);
                
                messageDiv.appendChild(header);
                messageDiv.appendChild(contentDiv);
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            addSystemMessage(content) {
                this.addMessage(content, 'system');
            }

            formatMessage(content) {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code style="background: rgba(79, 209, 199, 0.2); padding: 2px 4px; border-radius: 3px;">$1</code>')
                    .replace(/\n/g, '<br>');
            }

            showTypingIndicator() {
                this.typingIndicator.style.display = 'flex';
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }

            disableInput() {
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
            }

            enableInput() {
                if (this.selectedAgent) {
                    this.messageInput.disabled = false;
                    this.sendButton.disabled = false;
                    this.messageInput.focus();
                }
            }

            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            updateConnectionStatus(connected) {
                const indicator = document.getElementById('connectionIndicator');
                const status = document.getElementById('connectionStatus');
                
                if (connected) {
                    indicator.className = 'status-indicator status-active';
                    status.textContent = 'Connected';
                } else {
                    indicator.className = 'status-indicator status-inactive';
                    status.textContent = 'Disconnected';
                }
            }

            updateAgentStatus(agentData) {
                this.agents = agentData;
                this.renderAgents();
            }
        }

        // Initialize the application
        let cybersecuritySuite;
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing CybersecuritySuite...');
            try {
                cybersecuritySuite = new CybersecuritySuite();
                console.log('CybersecuritySuite initialized successfully');
            } catch (error) {
                console.error('Error initializing CybersecuritySuite:', error);
                // Fallback: try to load agents directly
                loadAgentsFallback();
            }
        });
        
        // Fallback function to load agents without Socket.IO
        async function loadAgentsFallback() {
            console.log('Using fallback agent loading...');
            try {
                const response = await fetch('/api/agents');
                const agents = await response.json();
                console.log('Fallback: Agents loaded:', agents);
                
                const agentsGrid = document.getElementById('agentsGrid');
                agentsGrid.innerHTML = '';
                
                Object.entries(agents).forEach(([agentId, agent]) => {
                    if (agentId === 'coordinator') return;
                    
                    const card = document.createElement('div');
                    card.className = 'agent-card';
                    card.innerHTML = `
                        <div class="agent-header">
                            <div class="agent-info">
                                <i class="fas fa-robot agent-icon"></i>
                                <div>
                                    <div class="agent-name">${agent.name}</div>
                                    <div class="agent-status">
                                        <div class="status-indicator status-${agent.status}"></div>
                                        ${agent.status.toUpperCase()}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="agent-description">Professional cybersecurity agent</div>
                        <div class="agent-capabilities">
                            <span class="capability-tag">AI Analysis</span>
                            <span class="capability-tag">Real-time Processing</span>
                        </div>
                        <div class="task-selector">
                            <select class="task-dropdown">
                                <option value="">Select a task...</option>
                                <option value="analyze">Analyze security threat</option>
                                <option value="scan">Perform security scan</option>
                            </select>
                                                     <button class="execute-btn" onclick="executeFallbackTask('${agentId}', '${agent.name}')">
                             <i class="fas fa-play"></i> Execute Task
                         </button>
                        </div>
                    `;
                    agentsGrid.appendChild(card);
                });
                
                console.log('Fallback: Agent cards rendered');
            } catch (error) {
                console.error('Fallback loading failed:', error);
                document.getElementById('agentsGrid').innerHTML = `
                    <div style="color: #f56565; text-align: center; padding: 2rem;">
                        Error loading agents: ${error.message}
                    </div>
                                 `;
             }
         }
         
         // Fallback task execution function
         async function executeFallbackTask(agentId, agentName) {
             const taskSelect = document.querySelector(`#agentsGrid .agent-card:nth-child(${Object.keys(agents).indexOf(agentId) + 1}) .task-dropdown`);
             if (!taskSelect) return;
             
             const selectedTask = taskSelect.value;
             if (!selectedTask) {
                 alert('Please select a task first');
                 return;
             }
             
             try {
                 // Show loading state
                 const executeBtn = taskSelect.parentElement.querySelector('.execute-btn');
                 const originalText = executeBtn.innerHTML;
                 executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
                 executeBtn.disabled = true;
                 
                 // Execute task via API
                 const response = await fetch('/api/execute-task', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         agent_type: agentId,
                         task_description: selectedTask,
                         user_id: 'user_' + Math.random().toString(36).substr(2, 9)
                     })
                 });
                 
                 const result = await response.json();
                 
                 // Show result
                 if (result.success) {
                     alert(`Task executed successfully!\n\nAgent: ${agentName}\nTask: ${selectedTask}\n\nResult: ${result.response.substring(0, 200)}...`);
                 } else {
                     alert(`Task execution failed: ${result.error || 'Unknown error'}`);
                 }
                 
                 // Reset button
                 executeBtn.innerHTML = originalText;
                 executeBtn.disabled = false;
                 taskSelect.value = '';
                 
             } catch (error) {
                 console.error('Task execution error:', error);
                 alert(`Error executing task: ${error.message}`);
                 
                 // Reset button
                 const executeBtn = taskSelect.parentElement.querySelector('.execute-btn');
                 executeBtn.innerHTML = '<i class="fas fa-play"></i> Execute Task';
                 executeBtn.disabled = false;
             }
         }
    </script>
</body>
</html>